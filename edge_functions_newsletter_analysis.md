# Análisis de Edge Functions - Sistema de Newsletter UGT Towa

## Resumen General
Las Edge Functions analizadas implementan un sistema completo de newsletter automatizado para la sección sindical UGT de Towa Pharmaceutical Europe. El sistema genera borradores mensuales, convierte contenido a PDF y envía newsletters a suscriptores válidos.

---

## 1. generate-monthly-draft-v3

### **Propósito**
Genera borradores mensuales automatizados del newsletter basados en contenido publicado durante el mes actual.

### **Filtros Temporales**
```typescript
// Línea 47-49: Filtro mensual
const now = new Date();
const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59).toISOString();
```
- **Rango temporal**: Mes completo actual (desde el día 1 hasta el último día del mes, 23:59:59)
- **Campo filtrado**: `published_at` en la tabla `newsletter_content`

### **Flujo de Datos**

#### **Ruta 1: Contenido Manual (Prioritario)**
```typescript
// Línea 52-60: Obtener contenido manual publicado este mes
${supabaseUrl}/rest/v1/newsletter_content?is_published=eq.true&published_at=gte.${firstDayOfMonth}&published_at=lte.${lastDayOfMonth}&order=created_at.asc
```
- **Condición**: Si existe contenido manual en `newsletter_content`
- **Tipos soportados**: news, events, statistics, directives, suggestions
- **Orden**: Ascendente por `created_at`

#### **Ruta 2: Contenido Automático (Fallback)**
```typescript
// Línea 78-96: Últimos 5 comunicados
${supabaseUrl}/rest/v1/communiques?is_published=eq.true&order=created_at.desc&limit=5

// Línea 100-116: Últimos 4 eventos
${supabaseUrl}/rest/v1/event_images?is_active=eq.true&order=event_date.desc&limit=4
```
- **Comunicados**: Últimos 5, ordenados por fecha descendente
- **Eventos**: Últimos 4, ordenados por `event_date` descendente
- **Activación**: Solo si no hay contenido manual

### **Estructura del Contenido Generado**
```typescript
const contentJson = {
    html: htmlContent,
    subject: title,
    sections: autoGeneratedContent,
    qrCode: qrCode,
    generatedAt: now.toISOString(),
    itemCount: autoGeneratedContent.news.length + autoGeneratedContent.events.length
};
```

### **Características Destacadas**
- ✅ **Verificación de configuración**: Comprueba `newsletter_config.auto_generation_enabled`
- ✅ **Actualización inteligente**: Actualiza borrador existente o crea nuevo
- ✅ **Notificación por email**: Envía notificación al administrador (línea 240-273)
- ✅ **QR Code**: Incluye QR code activo para afiliación
- ✅ **Template HTML**: Genera HTML responsive con estilos UGT (color #e50000)

---

## 2. generate-newsletter-pdf

### **Propósito**
Convierte el contenido HTML de newsletters enviados a formato PDF optimizado para impresión.

### **Flujo de Datos**
```typescript
// Línea 28-33: Obtener newsletter por ID
${supabaseUrl}/rest/v1/newsletters_sent?id=eq.${newsletterId}
```
- **Tabla fuente**: `newsletters_sent`
- **Campo principal**: `content` (HTML)
- **Campo secundario**: `subject`

### **Optimizaciones para PDF**
```css
@page {
    size: A4;
    margin: 2cm;
}

.page-break {
    page-break-after: always;
}

.section {
    page-break-inside: avoid;
}
```
- ✅ **Formato A4**: Configurado para impresión estándar
- ✅ **Márgenes**: 2cm en todos los lados
- ✅ **Control de saltos**: Evita分割 de secciones
- ✅ **Estilos de impresión**: Eliminación de elementos interactivos

### **Estadísticas Actualizadas**
```typescript
// Línea 58-72: Actualización de métricas
total_generated: currentGenerated + 1,
pdf_generated_at: new Date().toISOString(),
status: 'generated'
```

### **Características Destacadas**
- ✅ **HTML optimizado**: Agrega estilos específicos para PDF
- ✅ **Tracking de generación**: Registra cada generación de PDF
- ✅ **Elementos interactivos eliminados**: Remueve tracking pixels, enlaces

---

## 3. send-newsletter

### **Propósito**
Envía newsletters por email a suscriptores válidos usando Resend API.

### **Filtro de Suscriptores**
```typescript
// Línea 47-49: Filtro estricto por dominio
const validSubscribers = subscribers.filter(sub => 
    sub.email && sub.email.endsWith('@towapharmaceutical.com')
);
```
- ✅ **Solo dominio corporativo**: Exclusivamente `@towapharmaceutical.com`
- ✅ **Estado activo**: Solo `is_active=true`

### **Flujo de Datos**

#### **Obtención de Suscriptores**
```typescript
// Línea 29-34: Suscriptores activos
${supabaseUrl}/rest/v1/newsletter_subscribers?is_active=eq.true&select=email,name
```

#### **Procesamiento de Envío**
```typescript
// Línea 87-88: Tracking de aperturas
const trackingPixel = `<img src="${supabaseUrl}/functions/v1/track-email-event?newsletter_id=${newsletterId}&email=${encodeURIComponent(subscriber.email)}&event=open" width="1" height="1" style="display:none;" />`;
const trackedContent = htmlContent.replace('</body>', `${trackingPixel}</body>`);
```
- ✅ **Pixel de tracking**: Registra aperturas de email
- ✅ **Enlaces rastreados**: Trackea clics en contenido

### **Estructura de Envío**
```typescript
{
    from: 'UGT Towa <newsletter@ugttowa.com>',
    to: [subscriber.email],
    subject: subject,
    html: trackedContent
}
```

### **Analytics y Métricas**
```typescript
// Línea 64-78 y 108-121: Registro de analytics
body: JSON.stringify({
    newsletter_id: newsletterId,
    email: subscriber.email,
    bounced: false
})
```

### **Actualización de Estadísticas**
```typescript
// Línea 132-146: Métricas finales
body: JSON.stringify({
    status: 'sent',
    total_sent: successCount,
    sent_at: new Date().toISOString()
})
```

### **Características Destacadas**
- ✅ **Modo simulación**: Funciona sin API key para testing
- ✅ **Tracking completo**: Aperturas y envíos registrados
- ✅ **Filtrado por dominio**: Solo empleados de Towa
- ✅ **Manejo de errores**: Cuenta éxitos y fallos por separado
- ✅ **Analytics en tiempo real**: Registra cada envío en `email_analytics`

---

## Arquitectura de Datos

### **Tablas Principales**
1. **newsletter_config** - Configuración del sistema
2. **newsletter_content** - Contenido manual publicado
3. **newsletter_editions** - Borradores generados
4. **newsletter_subscribers** - Suscriptores activos
5. **newsletters_sent** - Newsletters enviados
6. **email_analytics** - Métricas de envío y apertura
7. **communiques** - Fuente de contenido automático
8. **event_images** - Eventos para galería

### **Configuración Requerida**
```typescript
// Variables de entorno necesarias
SUPABASE_URL
SUPABASE_SERVICE_ROLE_KEY
RESEND_API_KEY  // Opcional para modo simulación
```

### **Flujo Completo del Sistema**
1. **Generación automática** (cron/scheduler)
2. **Generación de PDF** (on-demand)
3. **Envío con tracking** (manual/automatic)
4. **Analytics y métricas** (automático)

---

## Conclusiones

### **Fortalezas del Sistema**
- ✅ **Automatización completa**: Generación mensual automática
- ✅ **Contenido dual**: Manual y automático
- ✅ **Tracking avanzado**: Aperturas, envíos, bounces
- ✅ **Filtrado estricto**: Solo suscriptores corporativos
- ✅ **PDF optimizado**: Formato profesional A4
- ✅ **Notificaciones**: Admin alertado de nuevas ediciones

### **Áreas de Mejora Potencial**
- ⚠️ **Filtros temporales**: Solo mes actual, no personalizables
- ⚠️ **Límites fijos**: 5 comunicados, 4 eventos (hardcoded)
- ⚠️ **Dominio hardcoded**: Solo @towapharmaceutical.com
- ⚠️ **Sin reintentos**: Fallos de envío no se reintentan
- ⚠️ **Template HTML**: No configurable desde admin

### **Recomendaciones**
1. **Parámetros configurables**: Hacer límites y filtros editables
2. **Múltiples dominios**: Permitir otros dominios corporativos
3. **Reintentos automáticos**: Sistema de queue para fallos
4. **Templates personalizables**: Editor de templates en admin
5. **Filtros avanzados**: Por fecha, categoría, importancia